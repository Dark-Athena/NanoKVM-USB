name: Build and Release NanoKVM-USB
on:
  push:
    tags:
      - 'v*'   # é€šè¿‡æ ‡ç­¾è§¦å‘ï¼ˆå¦‚ v1.0.1ï¼‰
  workflow_dispatch:   # æ·»åŠ æ‰‹åŠ¨å¯åŠ¨æ”¯æŒ
    inputs:            # å¯é€‰ï¼šè‡ªå®šä¹‰è¾“å…¥å‚æ•°
      version:
        description: 'è¾“å…¥ç‰ˆæœ¬å· (å¦‚ 1.0.1)'
        required: true
jobs:
  build-and-release:
    runs-on: windows-latest  # ä½¿ç”¨ Windows ç¯å¢ƒç¼–è¯‘
    steps:
      # æ­¥éª¤ 1ï¼šæ£€å‡ºä»£ç 
      - name: ğŸ›¬ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤ 2ï¼šè¿›å…¥ desktop ç›®å½•æ‰§è¡Œç®¡ç†å‘˜æƒé™ç¼–è¯‘
      - name: ğŸ”¨ Build with pnpm (Admin)
        working-directory: ./desktop  # è¿›å…¥ç›®æ ‡ç›®å½•
        run: |
          # æˆäºˆ PowerShell ç®¡ç†å‘˜æƒé™
          Start-Process PowerShell -ArgumentList "pnpm build:win" -Verb RunAs -Wait
        env:
          PNPM_VERSION: "8"  # æŒ‡å®š pnpm ç‰ˆæœ¬

      # æ­¥éª¤ 3ï¼šå®šä½ç”Ÿæˆçš„å®‰è£…æ–‡ä»¶ï¼ˆæ”¯æŒç‰ˆæœ¬å·åŠ¨æ€æ›´æ–°ï¼‰
      - name: ğŸ” Find Build Artifact
        id: find-exe
        run: |
          $exePath = Get-ChildItem -Path 'desktop/dist' -Filter 'NanoKVM-USB-*-setup.exe' | Select-Object -First 1
          if ($null -ne $exePath) {
            $version = $exePath.Name -replace 'NanoKVM-USB-(.*)-setup\.exe', '$1'
            echo "exe_file=$($exePath.FullName)" >> $env:GITHUB_OUTPUT
            echo "version=$version" >> $env:GITHUB_OUTPUT
          } else {
            Write-Error "å®‰è£…æ–‡ä»¶æœªæ‰¾åˆ°ï¼"
            exit 1
          }

      # æ­¥éª¤ 4ï¼šå‘å¸ƒåˆ° GitHub Release
      - name: ğŸš€ Publish Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.find-exe.outputs.version }}  # åŠ¨æ€ç”Ÿæˆæ ‡ç­¾
          name: "NanoKVM USB v${{ steps.find-exe.outputs.version }}"
          files: |
            ${{ steps.find-exe.outputs.exe_file }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
